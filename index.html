<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Studio Pro AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #2af598 0%, #009efd 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --text-main: #1a202c;
            --text-sub: #4a5568;
            --radius-lg: 24px;
            --radius-sm: 12px;
            --shadow-soft: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-glow: 0 0 20px rgba(118, 75, 162, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Layout */
        .app-container {
            width: 100%;
            max-width: 520px;
            position: relative;
            z-index: 1;
        }

        /* Glassmorphism Card */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }

        header h1 {
            font-size: 2rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 5px;
        }

        .badge {
            background: var(--text-main);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 20px;
            vertical-align: middle;
            margin-left: 8px;
        }

        .subtitle {
            color: var(--text-sub);
            font-size: 0.95rem;
            font-weight: 400;
        }

        .instructions {
            background: rgba(237, 242, 247, 0.8);
            padding: 15px 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 25px;
            font-size: 0.85rem;
            color: var(--text-sub);
            border-left: 4px solid #764ba2;
        }

        .instructions ul {
            padding-left: 20px;
            margin: 0;
        }

        /* Upload Zone */
        .upload-zone {
            border: 3px dashed #cbd5e0;
            border-radius: var(--radius-lg);
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.02);
        }

        .upload-content {
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-upload {
            background: var(--primary-gradient);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* Editor Area */
        .hidden { display: none !important; }

        .editor-area {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .canvas-container {
            background: white;
            padding: 10px;
            border-radius: var(--radius-sm);
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            background-image: 
                linear-gradient(45deg, #e2e8f0 25%, transparent 25%), 
                linear-gradient(-45deg, #e2e8f0 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #e2e8f0 75%), 
                linear-gradient(-45deg, transparent 75%, #e2e8f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: 8px;
            overflow: hidden;
            min-height: 200px;
            align-items: center;
        }

        canvas {
            max-width: 100%;
            height: auto;
            display: block;
            max-height: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn:active { transform: scale(0.97); }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
        }
        
        .btn-ai {
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);
            color: #d63384;
            box-shadow: 0 4px 15px rgba(255, 154, 158, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: var(--text-main);
            border: 2px solid #e2e8f0;
        }
        .btn-secondary:hover { border-color: #cbd5e0; background: #f7fafc; }

        .btn-success {
            background: var(--secondary-gradient);
            color: white;
            width: 100%;
            font-size: 1rem;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(42, 245, 152, 0.4);
        }

        /* Swatches */
        .bg-options {
            background: white;
            padding: 15px 20px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        .swatches { display: flex; gap: 12px; }
        .swatch-container input { display: none; }
        
        .swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: block;
        }

        .check-pattern {
            background: conic-gradient(#ccc 90deg, #fff 90deg 180deg, #ccc 180deg 270deg, #fff 270deg);
            background-size: 10px 10px;
        }

        .swatch-container input:checked + .swatch {
            transform: scale(1.2);
            box-shadow: 0 0 0 2px var(--text-main);
        }

        /* Spinner */
        .spinner {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 5px solid #667eea;
            animation: spin 1s linear infinite;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 10;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3748;
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 1;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.hidden { opacity: 0; transform: translate(-50%, 20px); pointer-events: none; }
    </style>
</head>
<body>

<main class="app-container">
    <header>
        <h1>Photo Studio Pro <span class="badge">AI</span></h1>
        <p class="subtitle">Intelligent Background Remover & Passport Maker</p>
    </header>

    <section class="card">
        <div class="instructions">
            <ul>
                <li><strong>Upload</strong> a clear portrait photo.</li>
                <li><strong>Enhance</strong> & Remove Background using AI simulation.</li>
                <li><strong>Smart Crop</strong> detects subject automatically.</li>
            </ul>
        </div>

        <!-- Upload Area -->
        <div class="upload-zone" id="drop-zone">
            <input type="file" id="file-input" accept="image/*" hidden>
            <div class="upload-content">
                <div class="upload-icon">‚ú®</div>
                <p style="margin-bottom: 20px; font-weight: 500; color: #4a5568;">Drag & Drop your photo here</p>
                <button type="button" class="btn-upload" id="btn-trigger-upload">
                    Choose Image
                </button>
            </div>
        </div>

        <!-- Editor Area -->
        <div class="editor-area hidden" id="editor-area">
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <canvas id="photo-canvas"></canvas>
                    <div id="loading-spinner" class="spinner hidden"></div>
                </div>
            </div>

            <div class="controls">
                <!-- AI Tools -->
                <div class="button-group">
                    <button id="btn-enhance" class="btn btn-ai">
                        <span>ü™Ñ</span> AI Enhance
                    </button>
                    <button id="btn-remove-bg" class="btn btn-primary">
                        <span>‚úÇÔ∏è</span> Remove BG
                    </button>
                </div>

                <!-- Passport & Crop -->
                <button id="btn-passport" class="btn btn-secondary" style="width: 100%;">
                    <span>ü§ñ</span> Smart Crop to Passport Size
                </button>

                <!-- Background Options -->
                <div class="bg-options">
                    <span class="label-text" style="font-weight: 600; font-size: 0.85rem;">Backdrop</span>
                    <div class="swatches">
                        <label class="swatch-container">
                            <input type="radio" name="bgcolor" value="transparent" checked>
                            <span class="swatch check-pattern" title="Transparent"></span>
                        </label>
                        <label class="swatch-container">
                            <input type="radio" name="bgcolor" value="#ffffff">
                            <span class="swatch" style="background-color: #ffffff;" title="White"></span>
                        </label>
                        <label class="swatch-container">
                            <input type="radio" name="bgcolor" value="#3b82f6">
                            <span class="swatch" style="background-color: #3b82f6;" title="Blue"></span>
                        </label>
                        <label class="swatch-container">
                            <input type="radio" name="bgcolor" value="#ef4444">
                            <span class="swatch" style="background-color: #ef4444;" title="Red"></span>
                        </label>
                        <label class="swatch-container">
                            <input type="radio" name="bgcolor" value="#9ca3af">
                            <span class="swatch" style="background-color: #9ca3af;" title="Gray"></span>
                        </label>
                    </div>
                </div>

                <!-- Download -->
                <button id="btn-download" class="btn btn-success">
                    <span>‚¨á</span> Download HD Result
                </button>
                
                <div style="text-align: center;">
                    <button id="btn-new-upload" style="background:none; border:none; color: #718096; cursor:pointer; font-size:0.85rem; font-weight: 500;">
                        ‚Ü∫ Start Over
                    </button>
                </div>
            </div>
        </div>
    </section>

    <div id="toast" class="toast hidden"></div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Elements ---
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const editorArea = document.getElementById('editor-area');
    const canvas = document.getElementById('photo-canvas');
    const ctx = canvas.getContext('2d');
    const spinner = document.getElementById('loading-spinner');
    const toast = document.getElementById('toast');
    
    // Buttons
    const btnRemoveBg = document.getElementById('btn-remove-bg');
    const btnEnhance = document.getElementById('btn-enhance');
    const btnPassport = document.getElementById('btn-passport');
    const btnDownload = document.getElementById('btn-download');
    const btnTriggerUpload = document.getElementById('btn-trigger-upload');
    const btnNewUpload = document.getElementById('btn-new-upload');
    const bgRadios = document.querySelectorAll('input[name="bgcolor"]');

    // --- State ---
    let originalImage = new Image();
    let processedImageData = null; 
    let currentBgColor = 'transparent'; 
    let isEnhanced = false;

    // --- Events ---
    btnTriggerUpload.addEventListener('click', (e) => { e.stopPropagation(); fileInput.click(); });
    dropZone.addEventListener('click', (e) => { if(e.target !== btnTriggerUpload) fileInput.click(); });
    fileInput.addEventListener('change', handleFileSelect);
    
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#667eea'; });
    dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = '#cbd5e0'; });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#cbd5e0';
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    btnRemoveBg.addEventListener('click', aiRemoveBackground);
    btnEnhance.addEventListener('click', aiEnhanceImage);
    btnPassport.addEventListener('click', smartCropPassport);
    btnDownload.addEventListener('click', downloadImage);
    
    btnNewUpload.addEventListener('click', () => {
        location.reload();
    });

    bgRadios.forEach(r => r.addEventListener('change', (e) => {
        currentBgColor = e.target.value;
        renderCanvas();
    }));

    // --- Functions ---

    function handleFileSelect(e) {
        if (e.target.files.length) handleFile(e.target.files[0]);
    }

    function handleFile(file) {
        if (!file.type.startsWith('image/')) {
            showToast('‚ö†Ô∏è Please upload an image file.');
            return;
        }
        toggleSpinner(true);
        const reader = new FileReader();
        reader.onload = (event) => {
            originalImage.onload = () => {
                canvas.width = originalImage.width;
                canvas.height = originalImage.height;
                processedImageData = null;
                isEnhanced = false;
                ctx.drawImage(originalImage, 0, 0);
                dropZone.classList.add('hidden');
                editorArea.classList.remove('hidden');
                toggleSpinner(false);
            };
            originalImage.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    // AI Feature 1: Image Enhancement (Brightness/Contrast/Saturation)
    function aiEnhanceImage() {
        if(isEnhanced) return;
        toggleSpinner(true);
        
        setTimeout(() => {
            const w = canvas.width;
            const h = canvas.height;
            const imgData = ctx.getImageData(0, 0, w, h);
            const data = imgData.data;

            // Simple "Vibrance" algorithm
            for (let i = 0; i < data.length; i += 4) {
                // Increase contrast
                const contrast = 1.2; // 20% boost
                const intercept = 128 * (1 - contrast);
                
                data[i] = data[i] * contrast + intercept;     // R
                data[i+1] = data[i+1] * contrast + intercept; // G
                data[i+2] = data[i+2] * contrast + intercept; // B
                
                // Slight saturation boost could be added here by converting to HSL, 
                // but contrast pop is usually enough for "AI Enhance" feel.
            }
            
            // Save to temp canvas to update state
            const tempC = document.createElement('canvas');
            tempC.width = w; tempC.height = h;
            tempC.getContext('2d').putImageData(imgData, 0, 0);
            
            // If we have already removed BG, we update processedImageData
            // If not, we act like this is a new "original" but keep logic simple
            // For this demo, let's update current view
            
            const newImg = new Image();
            newImg.onload = () => {
                if (processedImageData) processedImageData = newImg;
                else originalImage = newImg;
                
                renderCanvas();
                toggleSpinner(false);
                isEnhanced = true;
                showToast("‚ú® AI Enhancement Applied!");
            };
            newImg.src = tempC.toDataURL();
        }, 800);
    }

    // AI Feature 2: Background Removal with Feathering
    function aiRemoveBackground() {
        toggleSpinner(true);
        setTimeout(() => {
            const w = canvas.width;
            const h = canvas.height;
            // Draw current state to get data
            renderCanvas(); 
            const imgData = ctx.getImageData(0, 0, w, h);
            const data = imgData.data;
            
            // Top-left pixel as reference key
            const bgR = data[0], bgG = data[1], bgB = data[2];
            const threshold = 45; 

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const diff = Math.abs(r - bgR) + Math.abs(g - bgG) + Math.abs(b - bgB);

                if (diff < threshold) {
                    data[i+3] = 0; // Transparent
                } else if (diff < threshold + 20) {
                    // Feathering edge: semi-transparent
                    data[i+3] = (diff - threshold) / 20 * 255;
                }
            }

            const tempC = document.createElement('canvas');
            tempC.width = w; tempC.height = h;
            tempC.getContext('2d').putImageData(imgData, 0, 0);

            const newImg = new Image();
            newImg.onload = () => {
                processedImageData = newImg;
                renderCanvas();
                toggleSpinner(false);
                showToast("‚úÇÔ∏è Background Removed");
            };
            newImg.src = tempC.toDataURL();
        }, 1000);
    }

    // AI Feature 3: Smart Crop (Bounding Box Detection)
    function smartCropPassport() {
        toggleSpinner(true);
        setTimeout(() => {
            const source = processedImageData || originalImage;
            
            // 1. Analyze for bounding box of non-transparent pixels
            const tempC = document.createElement('canvas');
            tempC.width = source.width;
            tempC.height = source.height;
            const tCtx = tempC.getContext('2d');
            tCtx.drawImage(source, 0, 0);
            
            const pixels = tCtx.getImageData(0, 0, source.width, source.height).data;
            let minX = source.width, minY = source.height, maxX = 0, maxY = 0;
            let found = false;

            for (let y = 0; y < source.height; y++) {
                for (let x = 0; x < source.width; x++) {
                    const alpha = pixels[(y * source.width + x) * 4 + 3];
                    if (alpha > 20) { // If pixel is visible
                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;
                        found = true;
                    }
                }
            }

            // Fallback if full image is opaque or empty
            if (!found) { minX = 0; minY = 0; maxX = source.width; maxY = source.height; }

            // Add some padding to the bounding box
            const padding = 20;
            minX = Math.max(0, minX - padding);
            minY = Math.max(0, minY - padding);
            maxX = Math.min(source.width, maxX + padding);
            maxY = Math.min(source.height, maxY + padding);

            const contentW = maxX - minX;
            const contentH = maxY - minY;
            const aspect = contentW / contentH;

            // Target passport size
            const targetSize = 600;
            
            // Calculate src rect to maintain aspect ratio in square target
            let srcX, srcY, srcW, srcH;

            if (contentW > contentH) {
                // Wide content: center horizontally
                srcW = contentH; 
                srcH = contentH;
                srcX = minX + (contentW - contentH) / 2;
                srcY = minY;
            } else {
                // Tall content: center vertically
                srcW = contentW;
                srcH = contentW;
                srcX = minX;
                srcY = minY + (contentH - contentW) / 2;
            }

            // Draw to 600x600 canvas
            const finalC = document.createElement('canvas');
            finalC.width = targetSize;
            finalC.height = targetSize;
            const fCtx = finalC.getContext('2d');

            fCtx.drawImage(source, srcX, srcY, srcW, srcH, 0, 0, targetSize, targetSize);

            const resultImg = new Image();
            resultImg.onload = () => {
                processedImageData = resultImg;
                canvas.width = targetSize;
                canvas.height = targetSize;
                renderCanvas();
                toggleSpinner(false);
                showToast("ü§ñ Smart Crop Applied!");
            };
            resultImg.src = finalC.toDataURL();

        }, 800);
    }

    function renderCanvas() {
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);
        if (currentBgColor !== 'transparent') {
            ctx.fillStyle = currentBgColor;
            ctx.fillRect(0, 0, w, h);
        }
        const imgToDraw = processedImageData || originalImage;
        ctx.drawImage(imgToDraw, 0, 0, w, h);
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = 'passport-photo-pro.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast("‚úÖ Saved to Device");
    }

    function toggleSpinner(show) {
        if (show) spinner.classList.remove('hidden');
        else spinner.classList.add('hidden');
    }

    function showToast(msg) {
        toast.textContent = msg;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }
});
</script>
</body>
</html>